<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.ouroom.web.post.PostMapper">
	<resultMap id = "postResultMap" type = "map">
		<id property="seq" column="SEQ"></id>
		<result property= "title" column= "TITLE" javaType= "String"/>
		<result property= "content" column= "CONTENT" javaType= "String"/>
		<result property= "regiDate" column= "REGI_DATE" javaType= "String"/>
		<result property= "viewCnt" column= "VIEW_CNT" javaType= "int"/>
		<result property= "likeCnt" column= "LIKE_CNT" javaType= "int"/>
		<result property= "shareCnt" column= "SHARE_CNT" javaType= "int"/>
		<result property= "roomType" column= "ROOM_TYPE" javaType= "String"/>
		<result property= "roomSize" column= "ROOM_SIZE" javaType= "String"/>
		<result property= "memSeq" column= "MEM_SEQ" javaType= "int"/>
		<result property= "boardSeq" column= "BOARD_SEQ" javaType= "int"/>
		<result property= "image" column= "IMAGE" javaType= "String"/>
		<result property= "nickname" column= "NICKNAME" javaType= "String"/>
		<result property= "profile" column= "PROFILE" javaType= "String"/>
		<result property= "imageTagCnt" column= "IMGTAG_CNT" javaType= "String"/>
		<result property= "commentCnt" column= "COMMENT_CNT" javaType= "int"/>
		<result property= "keyword" column= "KEYWORD" javaType= "String"/>
		<result property= "postSeq" column= "POST_SEQ" javaType= "int"/>
		<result property= "itemTitle" column= "ITEM_TITLE" javaType= "String"/>
		<result property= "position" column= "POINT" javaType= "String"/>
		<result property= "itemSeq" column= "ITEM_SEQ" javaType= "int"/>
		<result property= "comment" column= "COMMENT" javaType= "String"/>
		<result property= "itemTitle" column= "ITEM_TITLE" javaType= "String"/>
		<result property= "category" column= "CATEGORY" javaType= "String"/>
		<result property= "lastUpdate" column= "LAST_UPDATE" javaType= "String"/>
   </resultMap>
	
	<insert id="postInseart" parameterType="map">
		INSERT INTO post
			(TITLE, CONTENT, REGI_DATE, VIEW_CNT, LIKE_CNT, SHARE_CNT, ROOM_TYPE, ROOM_SIZE, MEM_SEQ, BOARD_SEQ, IMAGE, LAST_UPDATE)
		VALUES
			(#{title}, #{content}, #{regiDate}, 0, 0, 0, #{roomType}, #{roomSize}, #{memSeq}, 1, #{image}, #{regiDate})
	</insert>
	<select id="postList" parameterType="map" resultMap="postResultMap">
		SELECT *
		FROM post_list_view
		<where>
			<if test=" beginRow != null and beginRow != '' ">
				No BETWEEN #{beginRow} AND #{endRow}
			</if>
		</where>
	</select>
	<select id="postSearch" parameterType="String" resultMap="postResultMap">
		SELECT A.*, COUNT(c.SEQ) AS COMMENT_CNT
		FROM (
			SELECT ROW_NUMBER() OVER(ORDER by p.SEQ DESC) AS No, p.*, h.KEYWORD, m.NICKNAME, m.PROFILE
			FROM hashtag h
			JOIN post p on h.POST_SEQ like p.SEQ
			JOIN member m on p.MEM_SEQ like m.seq
			WHERE h.KEYWORD like #{value}
			GROUP BY p.SEQ
		) A
		LEFT JOIN comment c ON A.SEQ LIKE c.ARTICLE_SEQ
		GROUP BY A.seq
	</select>
	<select id="postRetrieve" resultMap="postResultMap">
		SELECT *
		FROM post_detail_view
		<where>
			<if test=" memSeq != null and memSeq != '' ">
				MEM_SEQ LIKE #{memSeq}
			</if>
			<if test=" seq != null and seq != '' ">
				AND SEQ LIKE #{seq}
			</if>
		</where>
		LIMIT 1
	</select>
	<select id="postCount" parameterType="map" resultType="int">
		 SELECT COUNT(*)
		 FROM post
		 <where>
			<if test=" memSeq != null and memSeq != '' ">
				MEM_SEQ LIKE #{memSeq}
			</if>
		 </where>
	</select>
	<update id="postUpdate" parameterType="map">
		UPDATE post
		<set>
			TITLE = #{title}, 
			CONTENT = #{content},
			ROOM_TYPE = #{roomType},
			ROOM_SIZE = #{roomSize},
			IMAGE = #{image},
			LAST_UPDATE = #{lastUpdate},
			<if test=" viewCnt != null and viewCnt != '' ">VIEW_CNT = #{viewCnt},</if>
			<if test=" likeCnt != null and likeCnt != '' ">LIKE_CNT = #{likeCnt},</if>
			<if test=" shareCnt != null and shareCnt != '' ">SHARE_CNT = #{shareCnt}</if>
		</set>
		WHERE SEQ LIKE #{seq}
	</update>
	<delete id="postDelete" parameterType="map">
		DELETE FROM post
		WHERE SEQ LIKE #{seq}
	</delete>

	<insert id="hashTagInseart" parameterType="map">
		INSERT INTO hashtag
			(KEYWORD, POST_SEQ)
		VALUES
			(#{keyword}, #{seq})
	</insert>
	<select id="hashTagList" resultType="String">
		SELECT KEYWORD
		FROM hashtag
		<where>
			POST_SEQ LIKE #{value}
		</where>
	</select>
	<select id="hashTagSearch" resultType="String">
		SELECT KEYWORD
		FROM hashtag
		GROUP BY KEYWORD
	</select>
	<delete id="hashTagDelete" parameterType= "map">
		DELETE 
		FROM hashtag
		WHERE POST_SEQ LIKE #{seq}
	</delete>
	
	<insert id="imgTagInseart" parameterType= "map">
		INSERT INTO imgtag
			(ITEM_TITLE, POINT, ITEM_SEQ, POST_SEQ)
		VALUES
			(#{itemTitle}, #{posision}, #{itemSeq}, #{postSeq})
	</insert>
	<select id="imgTagList" resultMap= "postResultMap">
		SELECT t.ITEM_TITLE, t.POINT, t.ITEM_SEQ, i.PHOTO AS image, c.CATEGORY
		FROM imgtag t
		JOIN item i ON t.ITEM_SEQ LIKE i.SEQ
		JOIN category2 c ON i.CATEGORY2_SEQ = c.SEQ
		<where>
			POST_SEQ LIKE #{value}
		</where>
	</select>
	<select id="imgTagSearch" resultType="String">
		SELECT SEQ AS ITEM_SEQ, TITLE AS ITEM_TITLE
		FROM item
	</select>
	<delete id="imgTagDelete" parameterType= "map">
	DELETE FROM imgtag
	WHERE SEQ LIKE #{seq}
	</delete>
	
	<insert id="commentInseart" parameterType= "map">
		INSERT INTO comment
			(COMMENT, ARTICLE_SEQ, MEM_SEQ, BOARD_SEQ)
		VALUES
			(#{comment}, #{seq}, #{memSeq}, 1)
	</insert>
	<select id="commentList" resultMap="postResultMap">
		SELECT A.*
		FROM (
			SELECT
				ROW_NUMBER() OVER(ORDER BY p.SEQ DESC) AS No, 
				p.SEQ, p.COMMENT, p.POST_SEQ ,p.MEM_SEQ, p.NICKNAME, p.PROFILE
			FROM
				post_comment_view p
			WHERE POST_SEQ LIKE #{seq}
		) A
		<where>
			<if test=" beginRow != null and beginRow != '' ">
				A.No BETWEEN #{beginRow} AND #{endRow}
			</if>
		</where>
	</select>
	<select id="commentCount" parameterType="map" resultType="int">
		 SELECT COUNT(*)
		 FROM comment
		 <where>
			<if test=" seq != null and seq != '' ">
				ARTICLE_SEQ LIKE #{seq}
			</if>
		 </where>
	</select>
	<delete id="commentDelete" parameterType= "map">
		DELETE FROM mariadb.comment
		WHERE SEQ LIKE #{seq}
	</delete>
</mapper>